<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chamada — Professor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html{font-family:Poppins,system-ui,Roboto,sans-serif}
    .glass{backdrop-filter: blur(12px); background: rgba(255,255,255,.72)}
    @media (prefers-color-scheme: dark){
      body{color:#fff}
      .glass{background: rgba(17,24,39,.55)}
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          backgroundImage: {
            'futuro': 'radial-gradient(60rem 60rem at 20% -10%, rgba(99,102,241,.35), transparent 60%), radial-gradient(60rem 60rem at 120% 20%, rgba(168,85,247,.35), transparent 60%), linear-gradient(135deg, #0b0b12 0%, #0f1020 100%)'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-futuro">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold tracking-tight text-white/90 drop-shadow">Chamada — Professor</h1>
      <div class="flex items-center gap-2">
        <input id="search" placeholder="Filtrar..." class="px-3 py-2 rounded-2xl border border-white/10 bg-white/80 text-gray-900" />
        <button id="adminBtn" class="px-3 py-2 rounded-2xl bg-white/20 text-white hover:bg-white/30">Entrar (admin)</button>
      </div>
    </header>

    <main class="glass rounded-3xl shadow-2xl p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-white/90">Lista de Presença (<span id="day"></span>)</h2>
        <div id="count" class="text-sm text-white/80">0 aluno(s)</div>
      </div>

      <ul id="list" class="divide-y divide-white/10"></ul>

      <section id="adminControls" class="mt-6 hidden">
        <hr class="my-4 border-white/20"/>
        <h3 class="font-semibold mb-3 text-white/90">Controles do professor</h3>
        <div class="flex flex-col md:flex-row gap-2 mb-3">
          <input id="manualName" placeholder="Nome do aluno" class="flex-1 px-3 py-2 rounded-2xl border border-white/10 bg-white/80 text-gray-900" />
          <button id="addManual" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white">Adicionar</button>
          <button id="resetToday" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-700 text-white">Resetar Hoje</button>
        </div>
        <p class="text-xs text-white/70">Excluir um nome libera o reenvio para aquele dispositivo.</p>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
    import {
      getFirestore, collection, query, where, onSnapshot,
      addDoc, deleteDoc, doc, serverTimestamp, getDocs
    } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBnvgtO0EQy9GazG0ZQgU-eWTGAsa21bY0",
      authDomain: "lista-fd7fa.firebaseapp.com",
      projectId: "lista-fd7fa",
      storageBucket: "lista-fd7fa.firebasestorage.app",
      messagingSenderId: "225592695740",
      appId: "1:225592695740:web:71be86215f92b1a519a9b9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== util =====
    function todayKey(){
      const d = new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function formatTime(ts){
      try{ const dt = ts?.toDate ? ts.toDate() : null;
        return dt ? dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
      }catch{ return '' }
    }

    // ===== admin simples (código) =====
    const ADMIN_CODE = '112'; // troque aqui se quiser
    let adminOn = localStorage.getItem('adminOn')==='1';
    const adminBtn = document.getElementById('adminBtn');
    const adminControls = document.getElementById('adminControls');

    function setAdmin(on){
      adminOn = on;
      adminControls.classList.toggle('hidden', !on);
      adminBtn.textContent = on ? 'Sair (admin)' : 'Entrar (admin)';
      localStorage.setItem('adminOn', on ? '1' : '');
    }
    setAdmin(adminOn);

    adminBtn.addEventListener('click', ()=>{
      if (adminOn){ setAdmin(false); return; }
      const code = prompt('Código do professor:');
      if (code === ADMIN_CODE) setAdmin(true);
      else if (code) alert('Código incorreto.');
    });

    // ===== dados =====
    const dayEl = document.getElementById('day');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const searchEl = document.getElementById('search');
    const manualName = document.getElementById('manualName');
    const resetTodayBtn = document.getElementById('resetToday');

    dayEl.textContent = todayKey();

    // Snapshot do dia (ordenamos no cliente para evitar índice composto)
    let rows = [];
    const qToday = query(collection(db,'submissions'), where('day','==', todayKey()));
    onSnapshot(qToday, snap=>{
      rows = snap.docs.map(d=>({ id:d.id, ...d.data() }))
               .sort((a,b)=> (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
      render();
    });

    searchEl.addEventListener('input', render);

    function render(){
      const f = (searchEl.value||'').toLowerCase();
      const filtered = rows.filter(r => (r.name||'').toLowerCase().includes(f));
      countEl.textContent = `${filtered.length} aluno(s)`;
      listEl.innerHTML = filtered.map(r => `
        <li class="py-3 flex items-center justify-between">
          <div class="min-w-0">
            <div class="font-semibold truncate max-w-[60vw] md:max-w-[40vw]">${(r.name||'').replace(/</g,'&lt;')}</div>
            <div class="text-xs text-white/70">por: ${r.createdBy||'user'} • ${formatTime(r.createdAt)}</div>
          </div>
          ${adminOn ? `<button data-id="${r.id}" class="del px-3 py-1 rounded-2xl bg-red-600 hover:bg-red-700 text-white text-xs">Excluir</button>` : ''}
        </li>`).join('');

      if (adminOn){
        document.querySelectorAll('.del').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-id');
            if (!confirm('Excluir este aluno? Ele poderá reenviar hoje.')) return;
            try{ await deleteDoc(doc(db,'submissions',id)); } catch(e){ alert('Erro ao excluir.'); }
          };
        });
      }
    }

    // Adicionar manual
    document.getElementById('addManual').onclick = async () => {
      if (!adminOn) return alert('Entre no modo admin.');
      const name = manualName.value.trim();
      if (!name) return;
      try{
        await addDoc(collection(db,'submissions'), {
          name, deviceId: 'manual', day: todayKey(), createdAt: serverTimestamp(), createdBy: 'admin'
        });
        manualName.value='';
      }catch(e){ alert('Erro ao adicionar.'); }
    };

    // Reset manual de hoje
    resetTodayBtn.onclick = async ()=>{
      if (!adminOn) return alert('Entre no modo admin.');
      if (!confirm('Resetar todos os envios de HOJE?')) return;
      try{
        const snap = await getDocs(query(collection(db,'submissions'), where('day','==', todayKey())));
        const ops = snap.docs.map(d => deleteDoc(d.ref));
        await Promise.all(ops);
        alert('Lista de hoje resetada.');
      }catch(e){ alert('Erro ao resetar.'); }
    };

    // Reset automático quando virar o dia (quando o professor abrir o painel)
    (async function autoResetIfNewDay(){
      const lastDay = localStorage.getItem('lastDayOpened');
      const today = todayKey();
      localStorage.setItem('lastDayOpened', today);
      // Se quiser começar SEMPRE zerado no começo do dia, descomente abaixo:
      // if (lastDay && lastDay !== today && adminOn) {
      //   const snap = await getDocs(query(collection(db,'submissions'), where('day','==', today)));
      //   const ops = snap.docs.map(d => deleteDoc(d.ref));
      //   await Promise.all(ops);
      // }
    })();
  </script>
</body>
</html>
